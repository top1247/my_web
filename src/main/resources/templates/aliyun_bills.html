<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å•ç®¡ç†</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        :root {
            --primary-color: #0064c8;
            --text-main: #333333;
            --text-sub: #666666;
            --text-light: #999999;
            --border-color: #ebeef5;
            --bg-hover: #f5f7fa;
        }
        .content-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            padding: 24px;
            margin-bottom: 24px;
        }
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e0e3e9;
        }
        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .filter-input {
            height: 36px;
            padding: 0 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 13px;
            min-width: 140px;
        }
        input[type="month"] { width: 160px; }
        .btn-search {
            height: 36px;
            padding: 0 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-reset {
            height: 36px;
            padding: 0 15px;
            background-color: #fff;
            color: var(--text-sub);
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            line-height: 34px;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 4px;
        }
        .btn-action {
            height: 32px;
            padding: 0 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-delete { background: #fff0f0; color: #f56c6c; border: 1px solid #ffdede; }
        .btn-export { background: #f0f9eb; color: #67c23a; border: 1px solid #e1f3d8; }
        .table-container {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .modern-table thead {
            background-color: #f5f7fa;
            color: #909399;
            font-weight: 600;
        }
        .modern-table th {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .modern-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        .modern-table tbody tr:hover {
            background-color: var(--bg-hover);
        }
        .col-checkbox { width: 40px; text-align: center !important; }
        .col-money { text-align: right !important; }
        .cell-main { font-weight: 500; font-size: 14px; margin-bottom: 4px; }
        .cell-sub { font-size: 12px; color: var(--text-light); display: flex; align-items: center; gap: 6px; }
        .tag-gray { background: #f4f4f5; padding: 2px 6px; border-radius: 3px; color: #909399; font-family: monospace; }
        .config-text {
            max-width: 240px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="top-navbar">
        <div class="logo">
            <div class="logo-icon">â˜</div>
            <span>é˜¿é‡Œäº‘æˆæœ¬ç®¡ç†ç³»ç»Ÿ</span>
        </div>
        <div class="user-info">
            <span class="username" th:text="${username}"></span>
            <span th:if="${user_type == 'admin'}" style="color:#67c23a">[ç®¡ç†å‘˜]</span>
            <a th:href="@{/logout}" class="logout-link">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <div class="sidebar">
        <ul class="sidebar-menu">
            <li><a th:href="@{/}"><i>ğŸ </i> é¦–é¡µ</a></li>
            <li><a th:href="@{/aliyun/keys}"><i>ğŸ”‘</i> å¯†é’¥ç®¡ç†</a></li>
            <li><a th:href="@{/aliyun/bills}" class="active"><i>ğŸ“Š</i> è´¦å•ç®¡ç†</a></li>
            <li th:if="${user_type == 'admin'}" style="margin-top: 20px; padding: 8px 24px; color: #999; font-size: 12px;">ç®¡ç†å‘˜åŠŸèƒ½</li>
            <li th:if="${user_type == 'admin'}"><a th:href="@{/admin/users}"><i>ğŸ‘¥</i> ç”¨æˆ·ç®¡ç†</a></li>
            <li th:if="${user_type == 'admin'}"><a th:href="@{/admin/logs}"><i>ğŸ“</i> æ“ä½œæ—¥å¿—</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">è´¦å•ç®¡ç†</h1>
            <p class="page-subtitle">æŸ¥è¯¢å’Œç®¡ç†æ‚¨çš„é˜¿é‡Œäº‘è´¦å•æ•°æ®</p>
        </div>

        <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <div class="content-card">
            <h2 class="card-title">è·å–è´¦å•æ•°æ®</h2>
            <form id="fetchForm">
                <div class="form-inline">
                    <div class="form-group">
                        <label for="keyAlias">é€‰æ‹©è´¦å· *</label>
                        <select id="keyAlias" name="keyAlias" required>
                            <option value="">è¯·é€‰æ‹©è´¦å·</option>
                            <option th:each="alias : ${keyAliases}" th:value="${alias}" th:text="${alias}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateMode">æŸ¥è¯¢æ¨¡å¼ *</label>
                        <select id="dateMode" name="dateMode" required onchange="toggleDateMode()">
                            <option value="monthly">æŒ‰æœˆæŸ¥è¯¢ï¼ˆæœˆåº¦æ±‡æ€»ï¼‰</option>
                            <option value="daily">æŒ‰æ—¥æŸ¥è¯¢ï¼ˆæ¯æ—¥æ˜ç»†ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="billingCycle">è´¦æœŸæœˆä»½ *</label>
                        <input type="month" id="billingCycle" name="billingCycle" required>
                    </div>
                    <div class="form-group" id="billingDateGroup" style="display: none;">
                        <label for="billingDate">å…·ä½“æ—¥æœŸ *</label>
                        <input type="date" id="billingDate" name="billingDate">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">ğŸ” è·å–è´¦å•</button>
                    <button type="button" class="btn-success" onclick="exportBills()">ğŸ“¥ å¯¼å‡º Excel</button>
                </div>
            </form>

            <div class="alert alert-info" style="margin-top: 16px; font-size: 13px;">
                â„¹ <strong>æ¸©é¦¨æç¤ºï¼š</strong>
                <ul style="margin: 8px 0 0 20px; color: #666;">
                    <li>å½“æœˆè´¦å•æ•°æ®ä»…ä¾›å‚è€ƒï¼Œå¯èƒ½ä¼šæœ‰å»¶è¿Ÿè°ƒæ•´ï¼Œæœ€ç»ˆè´¦å•åœ¨æ¬¡æœˆ3æ—¥12:00åç”Ÿæ•ˆ</li>
                    <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è¿‡æ»¤é›¶è´¦å•è®°å½•ï¼Œæœªç»“ç®—çš„èµ„æºä¸ä¼šæ˜¾ç¤ºé‡‘é¢</li>
                    <li>å¦‚æŸ¥è¯¢è¾ƒè¿‘æœˆä»½æ— æ•°æ®ï¼Œè¯·ç­‰å¾…è´¦å•ç»“ç®—å®Œæˆåå†æŸ¥è¯¢</li>
                </ul>
            </div>
        </div>

        <div class="content-card">
            <h2 class="card-title" style="margin-bottom: 20px;">æœ¬åœ°è´¦å•æ•°æ®ç®¡ç†</h2>

            <div class="filter-section">
                <form th:action="@{/aliyun/bills}" method="get" class="filter-form">
                    <select name="keyAlias" class="filter-input">
                        <option value="">æ‰€æœ‰è´¦å·</option>
                        <option th:each="alias : ${keyAliases}" th:value="${alias}" th:text="${alias}"></option>
                    </select>

                    <input type="month" name="billingCycle" class="filter-input">

                    <input type="text" name="productName" class="filter-input" placeholder="è¾“å…¥äº§å“åç§° (å¦‚: ECS)">
                    <input type="text" name="instanceId" class="filter-input" placeholder="è¾“å…¥å®ä¾‹ID">

                    <select name="dateRange" class="filter-input">
                        <option value="">æ‰€æœ‰æ—¥æœŸ</option>
                        <option value="last7days">æœ€è¿‘7å¤©</option>
                        <option value="thismonth">æœ¬æœˆ</option>
                        <option value="lastmonth">ä¸Šæœˆ</option>
                    </select>

                    <button type="submit" class="btn-search">
                        <span>ğŸ”</span> ç­›é€‰
                    </button>
                    <a th:href="@{/aliyun/bills}" class="btn-reset">é‡ç½®</a>
                </form>
            </div>

            <div class="action-bar">
                <div class="action-left">
                    <button onclick="deleteSelected()" class="btn-action btn-delete">
                        <span>ğŸ—‘ï¸</span> æ‰¹é‡åˆ é™¤
                    </button>
                    <button onclick="exportSelected()" class="btn-action btn-export">
                        <span>ğŸ“¥</span> å¯¼å‡ºé€‰ä¸­
                    </button>
                </div>
                <div style="color: #606266; font-size: 13px;">
                    å…±æ‰¾åˆ° <strong style="color: var(--primary-color);" th:text="${total}"></strong> æ¡è®°å½•
                </div>
            </div>

            <div th:if="${not #lists.isEmpty(bills)}" class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th class="col-checkbox"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                            <th width="15%">è´¦å· / è´¦æœŸ</th>
                            <th width="25%">äº§å“ / å®ä¾‹ID</th>
                            <th>å®ä¾‹è¯¦æƒ… (åç§°/åœ°åŸŸ/é…ç½®)</th>
                            <th class="col-money" width="15%">æ¶ˆè´¹é‡‘é¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="bill : ${bills}">
                            <td class="col-checkbox">
                                <input type="checkbox" name="billId" th:value="${bill.id}" class="bill-checkbox">
                            </td>
                            <td>
                                <div class="cell-main" th:text="${bill.keyAlias}"></div>
                                <div class="cell-sub">
                                    <span>ğŸ“… <span th:text="${bill.billingCycle}"></span></span>
                                </div>
                                <div class="cell-sub" style="margin-top: 2px;">
                                    <span>ğŸ•’ <span th:text="${bill.billingDate}"></span></span>
                                </div>
                            </td>
                            <td>
                                <div class="cell-main" style="color: var(--primary-color);" th:text="${bill.productName}"></div>
                                <div class="cell-sub">
                                    <span class="tag-gray" th:text="${bill.instanceId}"></span>
                                </div>
                            </td>
                            <td>
                                <div class="cell-main" th:if="${bill.instanceName}" th:text="${bill.instanceName}"></div>

                                <div class="cell-sub">
                                    <span th:if="${bill.region}">ğŸ“ <span th:text="${bill.region}"></span> <span th:text="${bill.zone}"></span></span>
                                </div>

                                <div class="cell-sub" th:if="${bill.instanceConfig}">
                                    <span class="config-text" th:title="${bill.instanceConfig}">âš™ï¸ <span th:text="${bill.instanceConfig}"></span></span>
                                </div>
                            </td>
                            <td class="col-money">
                                <div style="font-size: 16px; font-weight: bold; color: #f56c6c;">
                                    Â¥ <span th:text="${#numbers.formatDecimal(bill.paymentAmount, 1, 2)}"></span>
                                </div>
                                <div class="cell-sub" style="justify-content: flex-end;">
                                    <span th:text="${bill.currency}"></span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div th:if="${#lists.isEmpty(bills)}" style="text-align: center; padding: 80px 0; background: #fafafa; border-radius: 8px; border: 1px dashed #e0e3e9;">
                <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">ğŸ“Š</div>
                <p style="color: #909399; font-size: 14px;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è´¦å•æ•°æ®</p>
                <a th:href="@{/aliyun/bills}" style="color: var(--primary-color); font-size: 13px; text-decoration: none;">æ¸…é™¤ç­›é€‰æ¡ä»¶</a>
            </div>
        </div>

    <div class="loading-overlay" id="loadingOverlay" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
        <div class="loading-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: white; padding: 40px; border-radius: 12px;">
            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="font-size: 16px; color: #666;">æ­£åœ¨è·å–è´¦å•æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>

    <script>
        function toggleDateMode() {
            const mode = document.getElementById('dateMode').value;
            const dateGroup = document.getElementById('billingDateGroup');
            const dateInput = document.getElementById('billingDate');
            if (mode === 'daily') {
                dateGroup.style.display = 'block';
                dateInput.required = true;
            } else {
                dateGroup.style.display = 'none';
                dateInput.required = false;
            }
        }

        document.getElementById('fetchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';

            const formData = new FormData(this);

            fetch('/aliyun/bills/fetch', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                overlay.style.display = 'none';
                if (data.success) {
                    alert('âœ“ ' + data.message);
                    location.reload();
                } else {
                    alert('âœ— é”™è¯¯: ' + data.message);
                }
            })
            .catch(error => {
                overlay.style.display = 'none';
                alert('âœ— è¯·æ±‚å¤±è´¥: ' + error.message);
            });
        });

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.bill-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function getSelectedIds() {
            const checkboxes = document.querySelectorAll('.bill-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function deleteSelected() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è´¦å•è®°å½•ï¼');
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + ids.length + ' æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            const formData = new FormData();
            formData.append('billIds', ids.join(','));

            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';

            fetch('/aliyun/bills/delete', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                overlay.style.display = 'none';
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(err => {
                overlay.style.display = 'none';
                alert('è¯·æ±‚é”™è¯¯: ' + err);
            });
        }

        function exportSelected() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                if(confirm('æœªé€‰ä¸­ä»»ä½•è®°å½•ã€‚æ˜¯å¦å¯¼å‡ºå½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„ã€æ‰€æœ‰ã€‘è®°å½•ï¼Ÿ')) {
                    const params = new URLSearchParams(window.location.search);
                    window.location.href = '/aliyun/bills/export?' + params.toString();
                }
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/aliyun/bills/export';
            form.style.display = 'none';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'billIds';
            input.value = ids.join(',');

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function exportBills() {
            const alias = document.getElementById('keyAlias').value;
            const cycle = document.getElementById('billingCycle').value;
            let url = '/aliyun/bills/export?';
            if (alias) url += 'keyAlias=' + encodeURIComponent(alias) + '&';
            if (cycle) url += 'billingCycle=' + cycle;
            window.location.href = url;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </script>
</body>
</html>
